---
title: "MY WHALE SHARK REPORT"
author: "AMICA - EVAN GINTING & HARSH JAIN"
format: html
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

```{r loadLibraries}
library(tidyverse)
library(ggplot2)
library(here)
library(dplyr)
library(sf)
```

## Introduction

Whale Shark (Rhincodon typus) is the largest of all fishes alive. It may grow up to 18 metres (m) in length, but commonly seen between 4 m to 12 m. It is typically blue-grey or brownish in color with a pattern of white spots and vertical lines on its body. In terms of the diet, they feed on plankton, small crustaceans, squid, and fishes. The main feature of their food processing tools are their filtering screens on the gills and their tiny, more than 300 hooked teeth in both jaws. They are found on all the tropical oceans of the world where the water temperatures are ranging from 21 to 25 degrees Celsius and typically at depths of up to 1000 meters. Whale sharks are generally known to be active swimmers, and their activity can vary throughout the day and night. They do not exhibit diurnal (daytime) or seasonal (summer/winter) patterns of activity in the same way that some other species do. However, they seasonally come close to inshore areas, especially at plankton-rich locations. In Australia, it is found primarily in northern Western Australia, the Northern Territory, and Queensland. Whale sharks are known to migrate to the Ningaloo Marine park during specific times of the year, usually between March and July which is associated with the availability of plankton and other food sources in the area. During this time, there is usually a big ecotourism activity happening here for the chance to swim with them. Sadly, now, their status is an endangered species due to massive hunt of parts of their bodies. Hence, Conservation measures, including protections and regulations, are being implemented to safeguard this species in Australia and many other countries.

Expectations:

-   We expect to observe seasonal patterns in whale shark sightings, with higher occurrences during winter months. 
-   We expect to see differences in the frequency of sightings between coastal areas and open ocean regions, indicating habitat preferences. 
-   We expect to observe declining occurrences up to this year (2023).
-   We anticipate the sharks tend to move from east to west during fall and west to east during summer.
-   We expect to spot the most occurrences in the northern Western Australia.


## Data description

### Whale-shark Data

This dataset contains the information about the occurence of Whale Shark (Rhincodon Typus) in Australia at a certain time and place. The data is retrieved from the [Atlas of Living Australia (ALA) Website](https://www.ala.org.au/). ALA is a collaborative, digital, open infrastructure that pulls together Australian biodiversity data from multiple sources, making it accessible and reusable.

```{r loadData}
# Extracting the occurence data from ALA Website
library(galah)
galah_config(email = "egin0003@student.monash.edu")
ws_raw <- galah_call() |>
  galah_identify("Rhincodon typus") |>
  atlas_occurrences()

# Saving the raw data
save(ws_raw, file = here::here("data-raw/ws_raw.rda")) 
```

The data is located in folder `data-raw` named as `ws_raw.rda`. It contains these variables:

| Variables        | Description                                                                                                                                                                                     |
|------------------------------------|------------------------------------|
| decimalLongitude | The geographic longitude (in decimal degrees) of the geographic center of a Location.                                                                                                           |
| decimalLatitude  | The geographic latitude (in decimal degrees) of the geographic center of a Location.                                                                                                            |
| eventDate        | The date-time or interval during which an Event occurred. For occurrences, this is the date-time when the event was recorded. Not suitable for a time in a geological context.                  |
| scientificName   | The full scientific name, with authorship and date information if known. When forming part of an Identification, this should be the name in lowest level taxonomic rank that can be determined. |
| taxonConceptID   | The ID in an external taxonomic database, like a sequence reference database for example.                                                                                                       |
| recordID         | The ID of the occurence.                                                                                                                                                                        |
| dataResourceName | The name identifying the data set from which the record was derived.                                                                                                                            |
| occurenceStatus  | A statement about the presence or absence of a Taxon at a Location.                                                                                                                             |

```{r wildOccurences}
#| warning: false
#| message: false
#| eval: true
#| include: true

# Extracting the assertion data from ALA Website 
ws_assert <- galah_call() |>
  galah_identify("Rhincodon typus") |>
  galah_select(group = "assertions") |>
  atlas_occurrences()

# Saving the assertion data
save(ws_raw, file = here::here("data-raw/ws_assertion.rda"))


# Extracting the event data from ALA Website
ws_event <- galah_call() |>
  galah_identify("Rhincodon typus") |>
  galah_select(group = "event") |>
  atlas_occurrences()

# Saving the event data
save(ws_raw, file = here::here("data-raw/ws_event.rda"))
```

### Weather stations data

The dataset contains the information about Weather station locations which can be found in a Global Historical Climatology Network (GHCN) database maintained by the National Oceanic and Atmospheric Administration. This data is downloaded using the rnoaa package.

```{r}
library(rnoaa)
aus_stations <- ghcnd_stations() |>
  filter(str_starts(id, "ASN")) |>
  filter(last_year >= 2020) |>
  mutate(wmo_id = as.numeric(wmo_id),
         name = str_to_lower(name)) |>
  select(-state, -gsn_flag) |>
  filter(element %in% c("PRCP", "TMAX", "TMIN")) |>
  nest(element: last_year) |>
  rowwise() |>
  filter(nrow(data) == 3) |>
  select(-data) 
```

| Variables        | Description                                                                                                                                                                                     |
|------------------------------------|------------------------------------|

|id                | An identifier associated with a specific station.                                |

|latitude          | The latitude (in decimal degrees) of the station's location.                     |

|longitude         | The longitude (in decimal degrees) of the station's location.                    |

|elevation         | The elevation (in meters) of the station's location.                             |

|name              | The name or description of the station.                                          |

|wmo_id            | The World Meteorological Organization (WMO) identifier associated with the station. |

### Downloading weather data from the nearest weather station (Learmonth Station)

This dataset contains the information about the weather(Precipitation, Minimum and Maximum temperature) recorded by the selected station.

```{r}
narrogin <- aus_stations |>
  filter(id == "ASN00005007") |>
  rowwise() |>
  mutate(ts = list(meteo_pull_monitors(
    monitors = id, var = c("PRCP", "TMAX", "TMIN"),
    date_min = "2004-01-01",
    date_max = "2023-09-13") |>
      select(-id))) |>
  rename(lat = latitude, long = longitude, elev = elevation) |> select(id, long, lat, elev, name, wmo_id, ts) %>%
  unnest(ts) |>
  mutate(tmax = tmax/10, tmin = tmin/ 10)
```

| Variables        | Description                                                                                                                                                                                     |
|------------------------------------|------------------------------------|

|id                | An identifier associated with a specific location or station.                    |

|long              | The longitude (in decimal degrees) of the location.                              |

|lat               | The latitude (in decimal degrees) of the location.                               |

|elev              | The elevation (in meters) of the location.                                       |

|name              | The name or description of the location or station.                              |

|wmo_id            | The World Meteorological Organization (WMO) identifier associated with the location.|

|date              | The date of the recorded weather data.                                           |

|prcp              | Precipitation amount.                                                            |

|tmax              | Maximum temperature.                                                             |

|tmin              | Minimum temperature.                                                             |

## Initial data analysis (IDA)
### Data Quality Check
#### General Check

- There are `r ws_raw$dataResourceName %>% n_distinct()` different data sources and upon referring their data collection method on atlas website, it is evident that all the sightings are wild sightings.
- ws_event data has the samplingProtocol variable which basically indicates what type of sighting or data collection method was used. Most of the values are missing for this variable so it is also not a reliable method to identify wild sightings.
- From ws_assert (assertion) data, we can refer to the `BASIS_OF_RECORD_INVALID` column, which provide information if the occurences are valid or invalid. Currently, there are `r ws_assert %>% filter(BASIS_OF_RECORD_INVALID == "TRUE") %>% nrow()` values recorded as TRUE indicating that they are invalid records. These invalid records will be removed to ensure the quality of the data.

#### Data Type Check
For the occurences dataset, we are going to perform some quality check, as mention below: 

```{r IDA}
library(visdat)
vis_dat(ws_raw)
# Checking data types and replacing them with correct data types
ws_raw <- ws_raw %>%
  mutate(
    decimalLatitude = as.numeric(decimalLatitude),
    decimalLongitude = as.numeric(decimalLongitude),
    eventDate = as.Date(eventDate)
  )
```
From the plot above, we can see:
- The classes for all the variables in the ws_raw data set are correct except for `eventDate` which needs to be of Date type and only include dates.
- There are a few missing values for `decimalLatitude` and `decimalLongitude` . We can also see that if `decimalLatitude` is missing, `decimalLongitude` is also missing and vice-versa.
- There are `r ws_raw %>% filter(is.na(eventDate)) %>% nrow()` missing values in the `eventDate` variable out of `r ws_raw %>% nrow()` records. 

#### Outliers Check
**Checking eventDate variables:**
```{r IDA2}
ws_raw %>% filter(!is.na(eventDate)) %>% ggplot(aes(y = year(eventDate))) + geom_boxplot()
```

- There are only a few outlier years out of which the year below 1980 is farthest from the population. 
- There are `r ws_raw %>% filter(year(eventDate) < 1990) %>% nrow()` rows with record year less than 1990 which will be removed as they are not really reliable.
- The other outliers might have some valid information since they follow natural order so we won't be excluding them in clean data.


**Checking Location of Occurences**
```{r IDA3}
library(leaflet)
m <- leaflet() %>%
  addTiles() %>%
  addMarkers(
    data = ws_raw,
    lat = ~ decimalLatitude,
    lng = ~ decimalLongitude,
    popup = paste0(
      "Lat:",
      ws_raw$decimalLatitude,
      "<br/>",
      "Long:",
      ws_raw$decimalLongitude
    )
  )
m
```

- When plotting the locations of whale shark spotting, it is evident that some instances are from around the world and not just Australian waters. 
- We will put identifier for occurences near coastal area and open ocean range area by looking at the map above.

### Finding nearest weather station

```{r}
# Plotting All Weather Station
ggplot() +
  geom_sf(data = states) +
  ylim(-45, -5) +
  xlim(110, 155) +
  geom_point(data = aus_stations, aes(x = longitude, y = latitude)) +
  theme_bw()

# Nearest Station
ggplot() +
  geom_sf(data = states) +
  ylim(-45, -5) +
  xlim(110, 155) +
  geom_point(data = (aus_stations %>% filter(name == "learmonth airport")), aes(x = longitude, y = latitude)) +
  theme_bw()
```

- In the first plot we have plotted all weather station recently active in Australia. 
- In the second plot we have plotted the weather station (Learmonth airport) which is closest to the site with most occurrences of whale sharks. Since we already have the site with the highest occurrences that is the Ningaloo reef, we were able to find the weather station using [this website](https://www.honeymoonguide.com.au/australia/ningaloo-reef-weather.html#:~:text=Note%3A%20Meteorological%20data%20for%20the%20Ningaloo%20Coast%20is).

### Data Cleansing and Transforming

**Whale Shark data **
```{r}
# Getting Invalid Record
ws_assert <- ws_assert %>%
  select(recordID, BASIS_OF_RECORD_INVALID)

# Joining Raw Occurence data to Assert data to filter out the invalid records
# Performing further data cleansing & manipulating
whale_shark <- ws_raw %>%
                left_join(ws_assert, by = "recordID") %>% #1281 rows
                filter(BASIS_OF_RECORD_INVALID == FALSE, #1249 rows
                       is.na(eventDate) | year(eventDate) > 1990, #1247 rows
                       is.na(decimalLatitude) == FALSE) %>% #1241 rows
                mutate(location = case_when(decimalLatitude == -22.6 & decimalLongitude == -113.65 ~ 'Open Range',
                                            decimalLatitude == 19.000669 & decimalLongitude == -112.067012 ~ 'Open Range',
                                            decimalLatitude == 1.6737 & decimalLongitude == -91.98911 ~ 'Open Range',
                                            decimalLatitude == 0.917 & decimalLongitude == -29.345 ~ 'Open Range',
                                            decimalLatitude == -23.86667 & decimalLongitude == -35.55 ~ 'Open Range',
                                            decimalLatitude == 4.302202 & decimalLongitude == 72.883557 ~ 'Open Range',
                                            TRUE ~ 'Coastal Area'),
                       season = case_when(month(eventDate) %in% c(12, 1, 2) ~ 'Summer',
                                          month(eventDate) %in% c(3, 4, 5) ~ 'Fall',
                                          month(eventDate) %in% c(6, 7, 8) ~ 'Winter',
                                          month(eventDate) %in% c(9, 10, 11) ~ 'Spring',
                                          TRUE ~ NA))
                       
# Removing unnecessary columns from data
whale_shark <- whale_shark %>% select(-4, -5, -7, -8, -9)


# Saving into RDA file
save(whale_shark, file = "data/whale_shark.rda")
```
In the code above, we have performed some steps of data cleansing, which include:
- Join the occurence data to assertion data by `recordID` variable.
- Taking the `BASIS_OF_RECORD_INVALID` into the occurence data and filter out the invalid records by setting the variable value into "False".
- Filter out the occurences that happened before 1990 as they are unreliable. 
- Filter out the occurences that has missing value in `decimalLatitude`.
- Add 2 new column as identifier. First column `location`, is an identifier for location when the whale sharks are spotted in the open ocean or coastal area based on `decimalLatitude` and `decimalLongitude`. Second column `season`, is a identifier for season (e.g. Summer, Fall, Winter, and Spring). These two columns are needed to perform the plot for our expectations.

**Weather Data**
Filtering out the variables that we won't need for our analysis using select query.
```{r}
narrogin_v2 <- narrogin %>%
                select(date, prcp, tmax, tmin)
```

### Joining weather data with whale shark data

```{r}
whale_shark_weather <- whale_shark %>%
                         # Filter occurrence to near learmonth weather station
                         filter(decimalLatitude < -20, decimalLatitude > -24,
                                decimalLongitude > 112, decimalLongitude < 115) %>%
                         left_join(narrogin_v2, by = c("eventDate" = "date")) %>%
                         mutate(sighting = ifelse(is.na(tmin) & is.na(tmax), 0, 1))

# Saving into RDA file
save(whale_shark_weather, file = "data/whale_shark_weather.rda")
```

## Visual Inference Analysis (EDA)

### **Expectation 1: We expect to observe seasonal patterns in whale shark sightings, with higher occurrences during winter months.** 
```{r}
#| label: fig-countoccur
#| fig-cap: "Number of Occurences per Season"
#| fig-width: 8
#| fig-heigth: 8
#| echo: true
#| warning: false
#| message: false

whale_shark %>%
  filter(is.na(eventDate) == FALSE) %>%
  group_by(season) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = fct_reorder(season, -count), y = count)) +
    geom_bar(stat = "identity", position = "dodge", fill = "darkturquoise") +
    geom_text(aes(label = count, x = season, y = count),
                              position = position_dodge(width = 0.9),
                              vjust = 1.5,
                              hjust = 0.5,
                              size = 4) +
    ggtitle("Number of Occurences per Season") +
    xlab("Season") +
    ylab("Count of Occurences") +
    theme(plot.title = element_text(face = "bold")) +
    theme_classic()
```
Based on plot above, it turns out that Winter season comes out as no 2 of the most occurence, only behind by three occurence to Spring season, which mean the data is very close to what our expectation was. 


### **Expectation 2: We expect to see differences in the frequency of sightings between coastal areas and open ocean regions, indicating habitat preferences.** 

```{r}
# Checking Layers of the GDB file to figure out which files we require for our boundaries.
st_layers(
  "data/Maritime_Boundaries_Database/Seas and Submerged Lands Act 1973/Seas and Submerged Lands Act 1973.gdb"
)

open_ocean_boundary <-
  st_read(
    "data/Maritime_Boundaries_Database/Seas and Submerged Lands Act 1973/Seas and Submerged Lands Act 1973.gdb",
    layer = "Exclusive_Economic_Zone_AMB2014a_Area"
  )

coastal_boundary <-
  st_read(
    "data/Maritime_Boundaries_Database/Seas and Submerged Lands Act 1973/Seas and Submerged Lands Act 1973.gdb",
    layer = "Territorial_Sea_AMB2014a_Area"
  )

points_sf1 <-
  st_as_sf(
    whale_shark,
    coords = c("decimalLongitude", "decimalLatitude"),
    crs = st_crs(open_ocean_boundary)
  )
sf_use_s2(FALSE)
points_sf2 <-
  st_as_sf(
    whale_shark,
    coords = c("decimalLongitude", "decimalLatitude"),
    crs = st_crs(coastal_boundary)
  )

points_within_coast <- st_intersection(points_sf2, coastal_boundary)
points_within_ocean <-
  st_intersection(points_sf1, open_ocean_boundary)

ggplot() +
  geom_sf(data = coastal_boundary) +
  geom_sf(data = points_within_coast,
          color = "red",
          size = 1) +
  geom_sf(data = points_within_ocean,
          color = "blue",
          size = 1) +
  ylim(-45,-5) +
  xlim(110, 155) +
  theme_minimal()
```

- As we can see from the map above, there are very few observations in the open ocean area and majority of the wild sightings have been in the coastal area indicated by red dots.
- Since the Geoscience Australia considers coastal waters different from territorial sea(coastal boundary), some of the points which are in the coastal waters are excluded from the plot. Also, shape file for coastal waters is not available which doesn't allow us to plot them on the map.
- So, we can say that our expectation has been met and the chances that whale sharks appear in the coastal area is higher than the open ocean region of Australia.

### **Expectation 3: We expect to observe declining occurrences up to this year (2023).**

```{r}
whale_shark %>%
  na.omit() %>%
  group_by(Year = year(eventDate)) %>%
  summarise(Sightings = n_distinct(recordID)) %>%
  ggplot(aes(x = Year, y = Sightings)) +
  geom_line() +
  geom_text(aes(label = ifelse(
    Sightings > 150,
    paste("Year: ", Year, "\nSharks: ",
          as.character(Sightings)),
    ""
  )),
  hjust = 0, vjust = 1) +
  theme_minimal() +
  labs(x = "Year",
       y = "Observations",
       title = "Whale Shark sightings every year")
```

- The plot suggests that there was a notable increase in whale shark sightings from around 2008 to 2013, with the highest number of sightings occurring in 2013. This period might represent a peak in whale shark observations.

- After the peak, there is a decline in sightings, but the decline stabilizes after 2017. The number of sightings remains relatively consistent from 2018 to 2023, without a clear trend of continuous decline.

- While there may be fluctuations in the number of sightings from year to year, the data does not show a significant decline in occurrences up to the year 2023. It suggests that the population of whale sharks in the observed area may have stabilized or reached a plateau, at least within the scope of the available data.

- Note that this interpretation is based on the available data and the assumption that the observations are representative of the entire whale shark population in the area. Factors such as changes in survey effort or environmental conditions may also influence the observed trends.

- The expectation is not met according to the data.

### **Expectation 4: We anticipate the sharks tend to move from east to west during fall and west to east during summer.**

```{r}
whale_shark %>% na.omit() %>%
  mutate(Direction = ifelse(decimalLongitude <
                              134, "West", "East")) %>%
  group_by(season, Direction, year(eventDate)) %>%
  summarise(sum = n_distinct(recordID)) %>%
  ggplot(aes(x = season, y = sum)) +
  geom_col() +
  labs(x = "Seasons",
       y = "Sightings",
       title = "Sightings East v/s West season wise") +
  facet_grid( ~ Direction) +
  coord_flip()
```

- Whale sharks generally prefer Western Australian waters more than Eastern waters. 
- They also prefer winter months over summer months in West whereas other way round in the East.
- This might suggest (if we get more data about the sharks in east), Sharks travel from west to east to enjoy summer months in east and east to west to enjoy winter months in west.
- Note: Here, 134 degrees longitude is used as reference line to separate the East from West since it equally divides the continents in two halves.

### **Expectation 5: We expect to spot the most occurrences in the northern Western Australia.**
```{r}
#| warning: false
#| message: false

library(rworldmap)

# Loading the World map
wmap <- rworldmap::getMap(resolution = "low") %>%
          st_as_sf()

# Filtering to Australia map only
australia <- wmap %>%
  filter(NAME == "Australia")

# Loading AU State
states <- read_sf(here::here('data/STE_2021_AUST_SHP_GDA2020/STE_2021_AUST_GDA2020.shp'))

# Plotting the Map
ggplot() +
  geom_sf(data = states) +
  ylim(-45, -5) +
  xlim(110, 155) +
  geom_count(data = whale_shark, aes(x = decimalLongitude, y = decimalLatitude, color = season)) +
  theme_bw()
```
As can be seen from the plot above, our expectation is satisfied with the fact that most of occurences happened in the northern part of Western Australia. This is align with the information that we gathered from different sources, which says whale shark usually migrate to Ningaloo Marine Park that is located in the northern Western Australia. On the other hand, the high number of occurences could also supported by the fact that there are eco-tourism around that area, meaning more people will be around that area (on certain season) and record the occurences.   

### Plotting whale sharks spotted near Learmonth weather station 

```{r}
#| warning: false
#| message: false

ggplot() +
  geom_sf(data = states) +
  ylim(-24, -21) +
  xlim(112, 116) +
  geom_count(data = whale_shark_weather, aes(x = decimalLongitude, y = decimalLatitude, color = season)) +
  geom_point(data = (aus_stations %>% filter(name == "learmonth airport")), aes(x = longitude, y = latitude, label = name)) +
  geom_label(data = (aus_stations %>% filter(name == "learmonth airport")), aes(label = name, x = longitude, y = latitude),
                              position = position_dodge(width = 0.9),
                              vjust = 0.5,
                              hjust = -0.05,
                              size = 4) +
  theme_classic()
```

Created a map that shows the distribution of whale shark sightings surrounding the location of Learmonth Airport. The color of the points represents different seasons when the sightings occurred while the size of the points represent the number of sightings at a particular location. According to the plot, we can note that the most occurrences are in the spring season as they and they are also spread out across the coast. Next, highest occurrences are during winter season and then summer followed by fall. During winter, they appear towards north of the weather station and during summer they appear in south. 

### Why labeling days when sighting occurs is necessary?

- So, we're trying to figure out how weather conditions relate to wildlife sightings, specifically with whale sharks. We've got two main datasets: one with daily weather data from NOAA weather stations, and another with records of when and where whale shark sightings occurred.

- Weather data is collected every day, like clockwork, but whale shark sightings don't happen every day. So, to connect the dots and see how weather affects sightings, we need a way to match up the weather conditions with whether a sighting happened on that day.

- That's where this "sighting occurred" or "didn't occur" label comes in. Basically, we're creating a new variable that says "1" if there was a whale shark sighting on a particular day and "0" if there wasn't.

- This is all about making our data analysis easier. With these labels, we can do things like calculate correlations between weather factors (precipitation, temperature) and sightings. We can test hypotheses like, "Do sightings increase when there are higher chances of rain?" or "Are sightings more likely in certain temperature ranges?"

- Plus, when we visualize the data, it's much clearer. We can make time series plots that show how weather conditions and sightings line up over time. And if we want to build models that predict when whale sharks might appear based on weather forecasts, these labels are essential.

## Summary



## References

Department of Fisheries, Government of Western Australia. (2011, September). Fisheries Fact Sheet: Whale Shark. https://www.fish.wa.gov.au/documents/recreational_fishing/fact_sheets/fact_sheet_whale_shark.pdf

McGrouther, Mark. (2022, October). Whale Shark, Rhincodon typus (Smith, 1828). Australian Museum. https://australian.museum/learn/animals/fishes/whale-shark-rhincodon-typus-smith-1828/

Britannica. (2023, August). Whale Shark. Britannica. https://www.britannica.com/animal/whale-shark

French, C.J. 2006. Australia's Maritime Zones/Boundaries Map. Geoscience Australia, Canberra. https://pid.geoscience.gov.au/dataset/ga/63690

Bowie, A. (n.d.). Best time to visit Ningaloo Reef. Honeymoon Guide. Retrieved October 5, 2023, from https://www.honeymoonguide.com.au/australia/ningaloo-reef-weather.html#:~:text=Note%3A%20Meteorological%20data%20for%20the%20Ningaloo%20Coast%20is
